<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>AbstractMultiValuedMapTest.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">commons-collections-collections-4.1 (25-Jun-2019 5:26:10 PM)</a> &gt; <a href="../../index.html" class="el_group">commons-collections-collections-4.1</a> &gt; <a href="../index.html" class="el_bundle">src/test/java</a> &gt; <a href="index.source.html" class="el_package">org.apache.commons.collections4.multimap</a> &gt; <span class="el_source">AbstractMultiValuedMapTest.java</span></div><h1>AbstractMultiValuedMapTest.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.commons.collections4.multimap;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import org.apache.commons.collections4.AbstractObjectTest;
import org.apache.commons.collections4.Bag;
import org.apache.commons.collections4.BulkTest;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.MapIterator;
import org.apache.commons.collections4.MultiSet;
import org.apache.commons.collections4.MultiValuedMap;
import org.apache.commons.collections4.SetValuedMap;
import org.apache.commons.collections4.bag.AbstractBagTest;
import org.apache.commons.collections4.bag.HashBag;
import org.apache.commons.collections4.collection.AbstractCollectionTest;
import org.apache.commons.collections4.map.AbstractMapTest;
import org.apache.commons.collections4.multiset.AbstractMultiSetTest;
import org.apache.commons.collections4.set.AbstractSetTest;

/**
 * Abstract test class for {@link MultiValuedMap} contract and methods.
 * &lt;p&gt;
 * To use, extend this class and implement the {@link #makeObject} method and if
 * necessary override the {@link #makeFullMap()} method.
 *
 * @since 4.1
 * @version $Id$
 */
public abstract class AbstractMultiValuedMapTest&lt;K, V&gt; extends AbstractObjectTest {

    /** Map created by reset(). */
    protected MultiValuedMap&lt;K, V&gt; map;

    /** MultiValuedHashMap created by reset(). */
    protected MultiValuedMap&lt;K, V&gt; confirmed;

    public AbstractMultiValuedMapTest(String testName) {
<span class="fc" id="L62">        super(testName);</span>
<span class="fc" id="L63">    }</span>

    @Override
    abstract public MultiValuedMap&lt;K, V&gt; makeObject();

    @Override
    public String getCompatibilityVersion() {
<span class="fc" id="L70">        return &quot;4.1&quot;; // MultiValuedMap has been added in version 4.1</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} support the &lt;code&gt;put&lt;/code&gt; and
     * &lt;code&gt;putAll&lt;/code&gt; operations adding new mappings.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support put adding.
     */
    public boolean isAddSupported() {
<span class="fc" id="L82">        return true;</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} support the &lt;code&gt;remove&lt;/code&gt; and
     * &lt;code&gt;clear&lt;/code&gt; operations.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support removal operations.
     */
    public boolean isRemoveSupported() {
<span class="fc" id="L94">        return true;</span>
    }

    /**
     * Returns true if the maps produced by {@link #makeObject()} and
     * {@link #makeFullMap()} supports null keys.
     * &lt;p&gt;
     * Default implementation returns true. Override if your collection class
     * does not support null keys.
     */
    public boolean isAllowNullKey() {
<span class="nc" id="L105">        return true;</span>
    }

    @Override
    public boolean isTestSerialization() {
<span class="fc" id="L110">        return true;</span>
    }

    /**
     * Returns the set of keys in the mappings used to test the map. This method
     * must return an array with the same length as {@link #getSampleValues()}
     * and all array elements must be different. The default implementation
     * constructs a set of String keys, and includes a single null key if
     * {@link #isAllowNullKey()} returns &lt;code&gt;true&lt;/code&gt;.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public K[] getSampleKeys() {
<span class="fc" id="L122">        final Object[] result = new Object[] {</span>
<span class="fc" id="L123">                &quot;one&quot;, &quot;one&quot;, &quot;two&quot;, &quot;two&quot;,</span>
<span class="fc" id="L124">                &quot;three&quot;, &quot;three&quot;</span>
        };
<span class="fc" id="L126">        return (K[]) result;</span>
    }

    /**
     * Returns the set of values in the mappings used to test the map. This
     * method must return an array with the same length as
     * {@link #getSampleKeys()}. The default implementation constructs a set of
     * String values
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public V[] getSampleValues() {
<span class="fc" id="L137">        final Object[] result = new Object[] {</span>
<span class="fc" id="L138">                &quot;uno&quot;, &quot;un&quot;, &quot;dos&quot;, &quot;deux&quot;,</span>
<span class="fc" id="L139">                &quot;tres&quot;, &quot;trois&quot;</span>
        };
<span class="fc" id="L141">        return (V[]) result;</span>
    }

    protected MultiValuedMap&lt;K, V&gt; makeFullMap() {
<span class="fc" id="L145">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L146">        addSampleMappings(map);</span>
<span class="fc" id="L147">        return map;</span>
    }

    protected void addSampleMappings(MultiValuedMap&lt;? super K, ? super V&gt; map) {
<span class="fc" id="L151">        final K[] keys = getSampleKeys();</span>
<span class="fc" id="L152">        final V[] values = getSampleValues();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        for (int i = 0; i &lt; keys.length; i++) {</span>
<span class="fc" id="L154">            map.put(keys[i], values[i]);</span>
        }
<span class="fc" id="L156">    }</span>

    /**
     * Override to return a MultiValuedMap other than ArrayListValuedHashMap
     * as the confirmed map.
     *
     * @return a MultiValuedMap that is known to be valid
     */
    public MultiValuedMap&lt;K, V&gt; makeConfirmedMap() {
<span class="fc" id="L165">        return new ArrayListValuedHashMap&lt;K, V&gt;();</span>
    }

    public MultiValuedMap&lt;K, V&gt; getConfirmed() {
<span class="fc" id="L169">        return this.confirmed;</span>
    }

    public void setConfirmed(MultiValuedMap&lt;K, V&gt; map) {
<span class="nc" id="L173">        this.confirmed = map;</span>
<span class="nc" id="L174">    }</span>

    public MultiValuedMap&lt;K, V&gt; getMap() {
<span class="fc" id="L177">        return this.map;</span>
    }

    /**
     * Resets the {@link #map} and {@link #confirmed} fields to empty.
     */
    public void resetEmpty() {
<span class="fc" id="L184">        this.map = makeObject();</span>
<span class="fc" id="L185">        this.confirmed = makeConfirmedMap();</span>
<span class="fc" id="L186">    }</span>

    /**
     * Resets the {@link #map} and {@link #confirmed} fields to full.
     */
    public void resetFull() {
<span class="fc" id="L192">        this.map = makeFullMap();</span>
<span class="fc" id="L193">        this.confirmed = makeConfirmedMap();</span>
<span class="fc" id="L194">        final K[] k = getSampleKeys();</span>
<span class="fc" id="L195">        final V[] v = getSampleValues();</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        for (int i = 0; i &lt; k.length; i++) {</span>
<span class="fc" id="L197">            confirmed.put(k[i], v[i]);</span>
        }
<span class="fc" id="L199">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testNoMappingReturnsEmptyCol() {
<span class="fc" id="L203">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L204">        assertTrue(map.get((K) &quot;whatever&quot;).isEmpty());</span>
<span class="fc" id="L205">    }</span>

    public void testMultipleValues() {
<span class="fc" id="L208">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L210">        Collection&lt;V&gt; col = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L211">        assertTrue(col.contains(&quot;uno&quot;));</span>
<span class="fc" id="L212">        assertTrue(col.contains(&quot;un&quot;));</span>
<span class="fc" id="L213">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testGet() {
<span class="fc" id="L217">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L218">        assertTrue(map.get((K) &quot;one&quot;).contains(&quot;uno&quot;));</span>
<span class="fc" id="L219">        assertTrue(map.get((K) &quot;one&quot;).contains(&quot;un&quot;));</span>
<span class="fc" id="L220">        assertTrue(map.get((K) &quot;two&quot;).contains(&quot;dos&quot;));</span>
<span class="fc" id="L221">        assertTrue(map.get((K) &quot;two&quot;).contains(&quot;deux&quot;));</span>
<span class="fc" id="L222">        assertTrue(map.get((K) &quot;three&quot;).contains(&quot;tres&quot;));</span>
<span class="fc" id="L223">        assertTrue(map.get((K) &quot;three&quot;).contains(&quot;trois&quot;));</span>
<span class="fc" id="L224">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testAddMappingThroughGet(){
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L229">            return;</span>
        }
<span class="fc" id="L231">        resetEmpty();</span>
<span class="fc" id="L232">        final MultiValuedMap&lt;K, V&gt; map =  getMap();</span>
<span class="fc" id="L233">        Collection&lt;V&gt; col1 = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L234">        Collection&lt;V&gt; col2 = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L235">        assertTrue(col1.isEmpty());</span>
<span class="fc" id="L236">        assertTrue(col2.isEmpty());</span>
<span class="fc" id="L237">        assertEquals(0, map.size());</span>
<span class="fc" id="L238">        col1.add((V) &quot;uno&quot;);</span>
<span class="fc" id="L239">        col2.add((V) &quot;un&quot;);</span>
<span class="fc" id="L240">        assertTrue(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L241">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L242">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L243">        assertTrue(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L244">        assertTrue(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L245">        assertTrue(col1.contains(&quot;un&quot;));</span>
<span class="fc" id="L246">        assertTrue(col2.contains(&quot;uno&quot;));</span>
<span class="fc" id="L247">    }</span>

    public void testRemoveMappingThroughGet() {
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L251">            return;</span>
        }
<span class="fc" id="L253">        resetFull();</span>
<span class="fc" id="L254">        final MultiValuedMap&lt;K, V&gt; map = getMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L256">        Collection&lt;V&gt; col = map.get((K) &quot;one&quot;);</span>
<span class="fc" id="L257">        assertEquals(2, col.size());</span>
<span class="fc" id="L258">        assertEquals(6, map.size());</span>
<span class="fc" id="L259">        col.remove(&quot;uno&quot;);</span>
<span class="fc" id="L260">        col.remove(&quot;un&quot;);</span>
<span class="fc" id="L261">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L262">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L263">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L264">        assertFalse(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L265">        assertFalse(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L266">        assertEquals(4, map.size());</span>
<span class="fc" id="L267">        col = map.remove(&quot;one&quot;);</span>
<span class="fc" id="L268">        assertNotNull(col);</span>
<span class="fc" id="L269">        assertEquals(0, col.size());</span>
<span class="fc" id="L270">    }</span>

    public void testRemoveMappingThroughGetIterator() {
<span class="fc bfc" id="L273" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L274">            return;</span>
        }
<span class="fc" id="L276">        resetFull();</span>
<span class="fc" id="L277">        final MultiValuedMap&lt;K, V&gt; map = getMap();</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L279">        Iterator&lt;V&gt; it = map.get((K) &quot;one&quot;).iterator();</span>
<span class="fc bfc" id="L280" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L281">            it.next();</span>
<span class="fc" id="L282">            it.remove();</span>
        }
<span class="fc" id="L284">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L285">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L286">        assertFalse(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L287">        assertFalse(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L288">        assertFalse(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L289">        assertEquals(4, map.size());</span>
<span class="fc" id="L290">        Collection&lt;V&gt; coll = map.remove(&quot;one&quot;);</span>
<span class="fc" id="L291">        assertNotNull(coll);</span>
<span class="fc" id="L292">        assertEquals(0, coll.size());</span>
<span class="fc" id="L293">    }</span>

    public void testContainsValue() {
<span class="fc" id="L296">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L297">        assertTrue(map.containsValue(&quot;uno&quot;));</span>
<span class="fc" id="L298">        assertTrue(map.containsValue(&quot;un&quot;));</span>
<span class="fc" id="L299">        assertTrue(map.containsValue(&quot;dos&quot;));</span>
<span class="fc" id="L300">        assertTrue(map.containsValue(&quot;deux&quot;));</span>
<span class="fc" id="L301">        assertTrue(map.containsValue(&quot;tres&quot;));</span>
<span class="fc" id="L302">        assertTrue(map.containsValue(&quot;trois&quot;));</span>
<span class="fc" id="L303">        assertFalse(map.containsValue(&quot;quatro&quot;));</span>
<span class="fc" id="L304">    }</span>

    public void testKeyContainsValue() {
<span class="fc" id="L307">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L308">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L309">        assertTrue(map.containsMapping(&quot;one&quot;, &quot;un&quot;));</span>
<span class="fc" id="L310">        assertTrue(map.containsMapping(&quot;two&quot;, &quot;dos&quot;));</span>
<span class="fc" id="L311">        assertTrue(map.containsMapping(&quot;two&quot;, &quot;deux&quot;));</span>
<span class="fc" id="L312">        assertTrue(map.containsMapping(&quot;three&quot;, &quot;tres&quot;));</span>
<span class="fc" id="L313">        assertTrue(map.containsMapping(&quot;three&quot;, &quot;trois&quot;));</span>
<span class="fc" id="L314">        assertFalse(map.containsMapping(&quot;four&quot;, &quot;quatro&quot;));</span>
<span class="fc" id="L315">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testValues() {
<span class="fc" id="L319">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L320">        final HashSet&lt;V&gt; expected = new HashSet&lt;V&gt;();</span>
<span class="fc" id="L321">        expected.add((V) &quot;uno&quot;);</span>
<span class="fc" id="L322">        expected.add((V) &quot;dos&quot;);</span>
<span class="fc" id="L323">        expected.add((V) &quot;tres&quot;);</span>
<span class="fc" id="L324">        expected.add((V) &quot;un&quot;);</span>
<span class="fc" id="L325">        expected.add((V) &quot;deux&quot;);</span>
<span class="fc" id="L326">        expected.add((V) &quot;trois&quot;);</span>
<span class="fc" id="L327">        final Collection&lt;V&gt; c = map.values();</span>
<span class="fc" id="L328">        assertEquals(6, c.size());</span>
<span class="fc" id="L329">        assertEquals(expected, new HashSet&lt;V&gt;(c));</span>
<span class="fc" id="L330">    }</span>

//    public void testKeyedIterator() {
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        final ArrayList&lt;Object&gt; actual = new ArrayList&lt;Object&gt;(IteratorUtils.toList(map.iterator(&quot;one&quot;)));
//        final ArrayList&lt;Object&gt; expected = new ArrayList&lt;Object&gt;(Arrays.asList(&quot;uno&quot;, &quot;un&quot;));
//        assertEquals(expected, actual);
//    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemoveAllViaValuesIterator() {
<span class="fc bfc" id="L341" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L342">            return;</span>
        }
<span class="fc" id="L344">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">        for (final Iterator&lt;?&gt; i = map.values().iterator(); i.hasNext();) {</span>
<span class="fc" id="L346">            i.next();</span>
<span class="fc" id="L347">            i.remove();</span>
        }
<span class="fc" id="L349">        assertTrue(map.get((K) &quot;one&quot;).isEmpty());</span>
<span class="fc" id="L350">        assertTrue(map.isEmpty());</span>
<span class="fc" id="L351">    }</span>

    public void testRemoveViaValuesRemove() {
<span class="fc bfc" id="L354" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L355">            return;</span>
        }
<span class="fc" id="L357">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L358">        Collection&lt;V&gt; values = map.values();</span>
<span class="fc" id="L359">        values.remove(&quot;uno&quot;);</span>
<span class="fc" id="L360">        values.remove(&quot;un&quot;);</span>
<span class="fc" id="L361">        assertFalse(map.containsKey(&quot;one&quot;));</span>
<span class="fc" id="L362">        assertEquals(4, map.size());</span>
<span class="fc" id="L363">    }</span>

    /*public void testRemoveViaGetCollectionRemove() {
        if (!isRemoveSupported()) {
            return;
        }
        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
        Collection&lt;V&gt; values = map.get(&quot;one&quot;);
        values.remove(&quot;uno&quot;);
        values.remove(&quot;un&quot;);
        assertFalse(map.containsKey(&quot;one&quot;));
        assertEquals(4, map.size());
    }*/

//    public void testRemoveAllViaKeyedIterator() {
//        if (!isRemoveSupported()) {
//            return;
//        }
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        for (final Iterator&lt;?&gt; i = map.iterator(&quot;one&quot;); i.hasNext();) {
//            i.next();
//            i.remove();
//        }
//        assertNull(map.get(&quot;one&quot;));
//        assertEquals(4, map.size());
//    }

    public void testEntriesCollectionIterator() {
<span class="fc" id="L391">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L392">        Collection&lt;V&gt; values = new ArrayList&lt;V&gt;(map.values());</span>
<span class="fc" id="L393">        Iterator&lt;Map.Entry&lt;K, V&gt;&gt; iterator = map.entries().iterator();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">        while (iterator.hasNext()) {</span>
<span class="fc" id="L395">            Map.Entry&lt;K, V&gt; entry = iterator.next();</span>
<span class="fc" id="L396">            assertTrue(map.containsMapping(entry.getKey(), entry.getValue()));</span>
<span class="fc" id="L397">            assertTrue(values.contains(entry.getValue()));</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">            if (isRemoveSupported()) {</span>
<span class="fc" id="L399">                assertTrue(values.remove(entry.getValue()));</span>
            }
        }
<span class="fc bfc" id="L402" title="All 2 branches covered.">        if (isRemoveSupported()) {</span>
<span class="fc" id="L403">            assertTrue(values.isEmpty());</span>
        }
<span class="fc" id="L405">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemoveAllViaEntriesIterator() {
<span class="fc bfc" id="L409" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L410">            return;</span>
        }
<span class="fc" id="L412">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">        for (final Iterator&lt;?&gt; i = map.entries().iterator(); i.hasNext();) {</span>
<span class="fc" id="L414">            i.next();</span>
<span class="fc" id="L415">            i.remove();</span>
        }
<span class="fc" id="L417">        assertTrue(map.get((K) &quot;one&quot;).isEmpty());</span>
<span class="fc" id="L418">        assertEquals(0, map.size());</span>
<span class="fc" id="L419">    }</span>

    public void testSize() {
<span class="fc" id="L422">        assertEquals(6, makeFullMap().size());</span>
<span class="fc" id="L423">    }</span>

    // -----------------------------------------------------------------------
    @SuppressWarnings(&quot;unchecked&quot;)
    public void testMapEquals() {
<span class="fc bfc" id="L428" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L429">            return;</span>
        }
<span class="fc" id="L431">        final MultiValuedMap&lt;K, V&gt; one = makeObject();</span>
<span class="fc" id="L432">        final Integer value = Integer.valueOf(1);</span>
<span class="fc" id="L433">        one.put((K) &quot;One&quot;, (V) value);</span>
<span class="fc" id="L434">        one.removeMapping(&quot;One&quot;, value);</span>

<span class="fc" id="L436">        final MultiValuedMap&lt;K, V&gt; two = makeObject();</span>
<span class="fc" id="L437">        assertEquals(two, one);</span>
<span class="fc" id="L438">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testSizeWithPutRemove() {
<span class="pc bpc" id="L442" title="1 of 4 branches missed.">        if (!isRemoveSupported() || !isAddSupported()) {</span>
<span class="fc" id="L443">            return;</span>
        }
<span class="fc" id="L445">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L446">        assertEquals(0, map.size());</span>
<span class="fc" id="L447">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L448">        assertEquals(1, map.size());</span>
<span class="fc" id="L449">        map.put((K) &quot;B&quot;, (V) &quot;BA&quot;);</span>
<span class="fc" id="L450">        assertEquals(2, map.size());</span>
<span class="fc" id="L451">        map.put((K) &quot;B&quot;, (V) &quot;BB&quot;);</span>
<span class="fc" id="L452">        assertEquals(3, map.size());</span>
<span class="fc" id="L453">        map.put((K) &quot;B&quot;, (V) &quot;BC&quot;);</span>
<span class="fc" id="L454">        assertEquals(4, map.size());</span>
<span class="fc" id="L455">        map.remove(&quot;A&quot;);</span>
<span class="fc" id="L456">        assertEquals(3, map.size());</span>
<span class="fc" id="L457">        map.removeMapping(&quot;B&quot;, &quot;BC&quot;);</span>
<span class="fc" id="L458">        assertEquals(2, map.size());</span>
<span class="fc" id="L459">    }</span>

    public void testKeySetSize() {
<span class="fc" id="L462">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L463">        assertEquals(3, map.keySet().size());</span>
<span class="fc" id="L464">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testSize_Key() {
<span class="fc" id="L468">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L469">        assertEquals(2, map.get((K) &quot;one&quot;).size());</span>
<span class="fc" id="L470">        assertEquals(2, map.get((K) &quot;two&quot;).size());</span>
<span class="fc" id="L471">        assertEquals(2, map.get((K) &quot;three&quot;).size());</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L473">            return;</span>
        }
<span class="fc" id="L475">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L476">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
        //assertEquals(0, map.get(&quot;B&quot;).size());
<span class="fc" id="L478">        map.put((K) &quot;B&quot;, (V) &quot;BA&quot;);</span>
<span class="fc" id="L479">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L480">        assertEquals(1, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L481">        map.put((K) &quot;B&quot;, (V) &quot;BB&quot;);</span>
<span class="fc" id="L482">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L483">        assertEquals(2, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L484">        map.put((K) &quot;B&quot;, (V) &quot;BC&quot;);</span>
<span class="fc" id="L485">        assertEquals(1, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L486">        assertEquals(3, map.get((K) &quot;B&quot;).size());</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">        if (!isRemoveSupported()) {</span>
<span class="nc" id="L488">            return;</span>
        }
<span class="fc" id="L490">        map.remove(&quot;A&quot;);</span>
        //assertEquals(0, map.get(&quot;A&quot;).size());
<span class="fc" id="L492">        assertEquals(3, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L493">        map.removeMapping(&quot;B&quot;, &quot;BC&quot;);</span>
        //assertEquals(0, map.get(&quot;A&quot;).size());
<span class="fc" id="L495">        assertEquals(2, map.get((K) &quot;B&quot;).size());</span>
<span class="fc" id="L496">    }</span>

//    @SuppressWarnings(&quot;unchecked&quot;)
//    public void testIterator_Key() {
//        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();
//        Iterator&lt;V&gt; it = map.iterator(&quot;one&quot;);
//        assertEquals(true, it.hasNext());
//        Set&lt;V&gt; values = new HashSet&lt;V&gt;();
//        while (it.hasNext()) {
//            values.add(it.next());
//        }
//        assertEquals(true, values.contains(&quot;un&quot;));
//        assertEquals(true, values.contains(&quot;uno&quot;));
//        assertEquals(false, map.iterator(&quot;A&quot;).hasNext());
//        assertEquals(false, map.iterator(&quot;A&quot;).hasNext());
//        if (!isAddSupported()) {
//            return;
//        }
//        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);
//        it = map.iterator(&quot;A&quot;);
//        assertEquals(true, it.hasNext());
//        it.next();
//        assertEquals(false, it.hasNext());
//    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testContainsValue_Key() {
<span class="fc" id="L523">        final MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L524">        assertEquals(true, map.containsMapping(&quot;one&quot;, &quot;uno&quot;));</span>
<span class="fc" id="L525">        assertEquals(false, map.containsMapping(&quot;two&quot;, &quot;2&quot;));</span>
<span class="fc bfc" id="L526" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L527">            return;</span>
        }
<span class="fc" id="L529">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L530">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;AA&quot;));</span>
<span class="fc" id="L531">        assertEquals(false, map.containsMapping(&quot;A&quot;, &quot;AB&quot;));</span>
<span class="fc" id="L532">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_Map1() {
<span class="fc bfc" id="L536" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L537">            return;</span>
        }
<span class="fc" id="L539">        final MultiValuedMap&lt;K, V&gt; original = makeObject();</span>
<span class="fc" id="L540">        original.put((K) &quot;key&quot;, (V) &quot;object1&quot;);</span>
<span class="fc" id="L541">        original.put((K) &quot;key&quot;, (V) &quot;object2&quot;);</span>

<span class="fc" id="L543">        final MultiValuedMap&lt;K, V&gt; test = makeObject();</span>
<span class="fc" id="L544">        test.put((K) &quot;keyA&quot;, (V) &quot;objectA&quot;);</span>
<span class="fc" id="L545">        test.put((K) &quot;key&quot;, (V) &quot;object0&quot;);</span>
<span class="fc" id="L546">        test.putAll(original);</span>

<span class="fc" id="L548">        assertEquals(2, test.keySet().size());</span>
<span class="fc" id="L549">        assertEquals(4, test.size());</span>
<span class="fc" id="L550">        assertEquals(1, test.get((K) &quot;keyA&quot;).size());</span>
<span class="fc" id="L551">        assertEquals(3, test.get((K) &quot;key&quot;).size());</span>
<span class="fc" id="L552">        assertEquals(true, test.containsValue(&quot;objectA&quot;));</span>
<span class="fc" id="L553">        assertEquals(true, test.containsValue(&quot;object0&quot;));</span>
<span class="fc" id="L554">        assertEquals(true, test.containsValue(&quot;object1&quot;));</span>
<span class="fc" id="L555">        assertEquals(true, test.containsValue(&quot;object2&quot;));</span>
<span class="fc" id="L556">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_Map2() {
<span class="fc bfc" id="L560" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L561">            return;</span>
        }
<span class="fc" id="L563">        final Map&lt;K, V&gt; original = new HashMap&lt;K, V&gt;();</span>
<span class="fc" id="L564">        original.put((K) &quot;keyX&quot;, (V) &quot;object1&quot;);</span>
<span class="fc" id="L565">        original.put((K) &quot;keyY&quot;, (V) &quot;object2&quot;);</span>

<span class="fc" id="L567">        final MultiValuedMap&lt;K, V&gt; test = makeObject();</span>
<span class="fc" id="L568">        test.put((K) &quot;keyA&quot;, (V) &quot;objectA&quot;);</span>
<span class="fc" id="L569">        test.put((K) &quot;keyX&quot;, (V) &quot;object0&quot;);</span>
<span class="fc" id="L570">        test.putAll(original);</span>

<span class="fc" id="L572">        assertEquals(3, test.keySet().size());</span>
<span class="fc" id="L573">        assertEquals(4, test.size());</span>
<span class="fc" id="L574">        assertEquals(1, test.get((K) &quot;keyA&quot;).size());</span>
<span class="fc" id="L575">        assertEquals(2, test.get((K) &quot;keyX&quot;).size());</span>
<span class="fc" id="L576">        assertEquals(1, test.get((K) &quot;keyY&quot;).size());</span>
<span class="fc" id="L577">        assertEquals(true, test.containsValue(&quot;objectA&quot;));</span>
<span class="fc" id="L578">        assertEquals(true, test.containsValue(&quot;object0&quot;));</span>
<span class="fc" id="L579">        assertEquals(true, test.containsValue(&quot;object1&quot;));</span>
<span class="fc" id="L580">        assertEquals(true, test.containsValue(&quot;object2&quot;));</span>
<span class="fc" id="L581">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testPutAll_KeyIterable() {
<span class="fc bfc" id="L585" title="All 2 branches covered.">        if (!isAddSupported()) {</span>
<span class="fc" id="L586">            return;</span>
        }
<span class="fc" id="L588">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L589">        Collection&lt;V&gt; coll = (Collection&lt;V&gt;) Arrays.asList(&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;);</span>

<span class="fc" id="L591">        assertEquals(true, map.putAll((K) &quot;A&quot;, coll));</span>
<span class="fc" id="L592">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L593">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L594">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L595">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

        try {
<span class="nc" id="L598">            map.putAll((K) &quot;A&quot;, null);</span>
<span class="nc" id="L599">            fail(&quot;expecting NullPointerException&quot;);</span>
<span class="pc" id="L600">        } catch (NullPointerException npe) {</span>
            // expected
        }

<span class="fc" id="L604">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L605">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L606">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L607">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

<span class="fc" id="L609">        assertEquals(false, map.putAll((K) &quot;A&quot;, new ArrayList&lt;V&gt;()));</span>
<span class="fc" id="L610">        assertEquals(3, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L611">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L612">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L613">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>

<span class="fc" id="L615">        coll = (Collection&lt;V&gt;) Arrays.asList(&quot;M&quot;);</span>
<span class="fc" id="L616">        assertEquals(true, map.putAll((K) &quot;A&quot;, coll));</span>
<span class="fc" id="L617">        assertEquals(4, map.get((K) &quot;A&quot;).size());</span>
<span class="fc" id="L618">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;X&quot;));</span>
<span class="fc" id="L619">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Y&quot;));</span>
<span class="fc" id="L620">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;Z&quot;));</span>
<span class="fc" id="L621">        assertEquals(true, map.containsMapping(&quot;A&quot;, &quot;M&quot;));</span>
<span class="fc" id="L622">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testRemove_KeyItem() {
<span class="pc bpc" id="L626" title="1 of 4 branches missed.">        if (!isRemoveSupported() || !isAddSupported()) {</span>
<span class="fc" id="L627">            return;</span>
        }
<span class="fc" id="L629">        final MultiValuedMap&lt;K, V&gt; map = makeObject();</span>
<span class="fc" id="L630">        map.put((K) &quot;A&quot;, (V) &quot;AA&quot;);</span>
<span class="fc" id="L631">        map.put((K) &quot;A&quot;, (V) &quot;AB&quot;);</span>
<span class="fc" id="L632">        map.put((K) &quot;A&quot;, (V) &quot;AC&quot;);</span>
<span class="fc" id="L633">        assertEquals(false, map.removeMapping(&quot;C&quot;, &quot;CA&quot;));</span>
<span class="fc" id="L634">        assertEquals(false, map.removeMapping(&quot;A&quot;, &quot;AD&quot;));</span>
<span class="fc" id="L635">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AC&quot;));</span>
<span class="fc" id="L636">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AB&quot;));</span>
<span class="fc" id="L637">        assertEquals(true, map.removeMapping(&quot;A&quot;, &quot;AA&quot;));</span>
        //assertEquals(new MultiValuedHashMap&lt;K, V&gt;(), map);
<span class="fc" id="L639">    }</span>

    public void testKeysMultiSet() {
<span class="fc" id="L642">        MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L643">        MultiSet&lt;K&gt; keyMultiSet = map.keys();</span>
<span class="fc" id="L644">        assertEquals(2, keyMultiSet.getCount(&quot;one&quot;));</span>
<span class="fc" id="L645">        assertEquals(2, keyMultiSet.getCount(&quot;two&quot;));</span>
<span class="fc" id="L646">        assertEquals(2, keyMultiSet.getCount(&quot;three&quot;));</span>
<span class="fc" id="L647">        assertEquals(6, keyMultiSet.size());</span>
<span class="fc" id="L648">    }</span>

    public void testKeysBagIterator() {
<span class="fc" id="L651">        MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L652">        Collection&lt;K&gt; col = new ArrayList&lt;K&gt;();</span>
<span class="fc" id="L653">        Iterator&lt;K&gt; it = map.keys().iterator();</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">        while (it.hasNext()) {</span>
<span class="fc" id="L655">            col.add(it.next());</span>
        }
<span class="fc" id="L657">        Bag&lt;K&gt; bag = new HashBag&lt;K&gt;(col);</span>
<span class="fc" id="L658">        assertEquals(2, bag.getCount(&quot;one&quot;));</span>
<span class="fc" id="L659">        assertEquals(2, bag.getCount(&quot;two&quot;));</span>
<span class="fc" id="L660">        assertEquals(2, bag.getCount(&quot;three&quot;));</span>
<span class="fc" id="L661">        assertEquals(6, bag.size());</span>
<span class="fc" id="L662">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testKeysBagContainsAll() {
<span class="fc" id="L666">        MultiValuedMap&lt;K, V&gt; map = makeFullMap();</span>
<span class="fc" id="L667">        MultiSet&lt;K&gt; keyMultiSet = map.keys();</span>
<span class="fc" id="L668">        Collection&lt;K&gt; col = (Collection&lt;K&gt;) Arrays.asList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;one&quot;, &quot;two&quot;, &quot;three&quot;);</span>
<span class="fc" id="L669">        assertTrue(keyMultiSet.containsAll(col));</span>
<span class="fc" id="L670">    }</span>

    public void testAsMapGet() {
<span class="fc" id="L673">        resetEmpty();</span>
<span class="fc" id="L674">        Map&lt;K, Collection&lt;V&gt;&gt; mapCol = getMap().asMap();</span>
<span class="fc" id="L675">        assertNull(mapCol.get(&quot;one&quot;));</span>
<span class="fc" id="L676">        assertEquals(0, mapCol.size());</span>

<span class="fc" id="L678">        resetFull();</span>
<span class="fc" id="L679">        mapCol = getMap().asMap();</span>
<span class="fc" id="L680">        Collection&lt;V&gt; col = mapCol.get(&quot;one&quot;);</span>
<span class="fc" id="L681">        assertNotNull(col);</span>
<span class="fc" id="L682">        assertTrue(col.contains(&quot;un&quot;));</span>
<span class="fc" id="L683">        assertTrue(col.contains(&quot;uno&quot;));</span>
<span class="fc" id="L684">    }</span>

    public void testAsMapRemove() {
<span class="fc bfc" id="L687" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L688">            return;</span>
        }
<span class="fc" id="L690">        resetFull();</span>
<span class="fc" id="L691">        Map&lt;K, Collection&lt;V&gt;&gt; mapCol = getMap().asMap();</span>
<span class="fc" id="L692">        mapCol.remove(&quot;one&quot;);</span>
<span class="fc" id="L693">        assertFalse(getMap().containsKey(&quot;one&quot;));</span>
<span class="fc" id="L694">        assertEquals(4, getMap().size());</span>
<span class="fc" id="L695">    }</span>

    public void testMapIterator() {
<span class="fc" id="L698">        resetEmpty();</span>
<span class="fc" id="L699">        MapIterator&lt;K, V&gt; mapIt  = getMap().mapIterator();</span>
<span class="fc" id="L700">        assertFalse(mapIt.hasNext());</span>

<span class="fc" id="L702">        resetFull();</span>
<span class="fc" id="L703">        mapIt = getMap().mapIterator();</span>
<span class="fc bfc" id="L704" title="All 2 branches covered.">        while (mapIt.hasNext()) {</span>
<span class="fc" id="L705">            K key = mapIt.next();</span>
<span class="fc" id="L706">            V value = mapIt.getValue();</span>
<span class="fc" id="L707">            assertTrue(getMap().containsMapping(key, value));</span>
        }
<span class="fc" id="L709">    }</span>

    public void testMapIteratorRemove() {
<span class="fc bfc" id="L712" title="All 2 branches covered.">        if (!isRemoveSupported()) {</span>
<span class="fc" id="L713">            return;</span>
        }
<span class="fc" id="L715">        resetFull();</span>
<span class="fc" id="L716">        MapIterator&lt;K, V&gt; mapIt = getMap().mapIterator();</span>
<span class="fc bfc" id="L717" title="All 2 branches covered.">        while (mapIt.hasNext()) {</span>
<span class="fc" id="L718">            mapIt.next();</span>
<span class="fc" id="L719">            mapIt.remove();</span>
        }
<span class="fc" id="L721">        assertTrue(getMap().isEmpty());</span>
<span class="fc" id="L722">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public void testMapIteratorUnsupportedSet() {
<span class="fc" id="L726">        resetFull();</span>
<span class="fc" id="L727">        MapIterator&lt;K, V&gt; mapIt = getMap().mapIterator();</span>
<span class="fc" id="L728">        mapIt.next();</span>
        try {
<span class="nc" id="L730">            mapIt.setValue((V) &quot;some value&quot;);</span>
<span class="nc" id="L731">            fail();</span>
<span class="pc" id="L732">        } catch (UnsupportedOperationException e) {</span>
        }
<span class="fc" id="L734">    }</span>

    // -----------------------------------------------------------------------
    // Manual serialization testing as this class cannot easily
    // extend the AbstractTestMap
    // -----------------------------------------------------------------------

    public void testEmptyMapCompatibility() throws Exception {
<span class="fc" id="L742">        final MultiValuedMap&lt;?, ?&gt; map = makeObject();</span>
<span class="fc" id="L743">        final MultiValuedMap&lt;?, ?&gt; map2 =</span>
<span class="fc" id="L744">                (MultiValuedMap&lt;?, ?&gt;) readExternalFormFromDisk(getCanonicalEmptyCollectionName(map));</span>
<span class="fc" id="L745">        assertEquals(&quot;Map is empty&quot;, 0, map2.size());</span>
<span class="fc" id="L746">    }</span>

    @SuppressWarnings({ &quot;rawtypes&quot;, &quot;unchecked&quot; })
    public void testFullMapCompatibility() throws Exception {
<span class="fc" id="L750">        final MultiValuedMap map = makeFullMap();</span>
<span class="fc" id="L751">        final MultiValuedMap map2 =</span>
<span class="fc" id="L752">                (MultiValuedMap) readExternalFormFromDisk(getCanonicalFullCollectionName(map));</span>
<span class="fc" id="L753">        assertEquals(&quot;Map is the right size&quot;, map.size(), map2.size());</span>
<span class="fc bfc" id="L754" title="All 2 branches covered.">        for (final Object key : map.keySet()) {</span>
<span class="fc" id="L755">            assertTrue(&quot;Map had inequal elements&quot;,</span>
<span class="fc" id="L756">                       CollectionUtils.isEqualCollection(map.get(key), map2.get(key)));</span>
<span class="fc bfc" id="L757" title="All 2 branches covered.">            if (isRemoveSupported()) {</span>
<span class="fc" id="L758">                map2.remove(key);</span>
            }
        }
<span class="fc bfc" id="L761" title="All 2 branches covered.">        if (isRemoveSupported()) {</span>
<span class="fc" id="L762">            assertEquals(&quot;Map had extra values&quot;, 0, map2.size());</span>
        }
<span class="fc" id="L764">    }</span>

    // Bulk Tests
    /**
     * Bulk test {@link MultiValuedMap#entries()}. This method runs through all
     * of the tests in {@link AbstractCollectionTest}. After modification
     * operations, {@link #verify()} is invoked to ensure that the map and the
     * other collection views are still valid.
     *
     * @return a {@link AbstractCollectionTest} instance for testing the map's
     *         values collection
     */
    public BulkTest bulkTestMultiValuedMapEntries() {
<span class="fc" id="L777">        return new TestMultiValuedMapEntries();</span>
    }

    public class TestMultiValuedMapEntries extends AbstractCollectionTest&lt;Entry&lt;K, V&gt;&gt; {
<span class="fc" id="L781">        public TestMultiValuedMapEntries() {</span>
<span class="fc" id="L782">            super(&quot;&quot;);</span>
<span class="fc" id="L783">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public Entry&lt;K, V&gt;[] getFullElements() {
<span class="fc" id="L788">            return makeFullMap().entries().toArray(new Entry[0]);</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeObject() {
<span class="fc" id="L793">            return AbstractMultiValuedMapTest.this.makeObject().entries();</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeFullCollection() {
<span class="fc" id="L798">            return AbstractMultiValuedMapTest.this.makeFullMap().entries();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L803">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
            // Add not supported in entries view
<span class="fc" id="L809">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L814">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L819">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L824">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L825">            setCollection(AbstractMultiValuedMapTest.this.getMap().entries());</span>
<span class="fc" id="L826">            TestMultiValuedMapEntries.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().entries());</span>
<span class="fc" id="L827">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L831">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L832">            setCollection(AbstractMultiValuedMapTest.this.getMap().entries());</span>
<span class="fc" id="L833">            TestMultiValuedMapEntries.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().entries());</span>
<span class="fc" id="L834">        }</span>

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeConfirmedCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L839">            return null;</span>
        }

        @Override
        public Collection&lt;Entry&lt;K, V&gt;&gt; makeConfirmedFullCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L845">            return null;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#keySet()}. This method runs through all
     * of the tests in {@link AbstractSetTest}. After modification operations,
     * {@link #verify()} is invoked to ensure that the map and the other
     * collection views are still valid.
     *
     * @return a {@link AbstractSetTest} instance for testing the map's key set
     */
    public BulkTest bulkTestMultiValuedMapKeySet() {
<span class="fc" id="L859">        return new TestMultiValuedMapKeySet();</span>
    }

    public class TestMultiValuedMapKeySet extends AbstractSetTest&lt;K&gt; {
<span class="fc" id="L863">        public TestMultiValuedMapKeySet() {</span>
<span class="fc" id="L864">            super(&quot;&quot;);</span>
<span class="fc" id="L865">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
        @Override
        public K[] getFullElements() {
<span class="fc" id="L870">            return (K[]) AbstractMultiValuedMapTest.this.makeFullMap().keySet().toArray();</span>
        }

        @Override
        public Set&lt;K&gt; makeObject() {
<span class="fc" id="L875">            return AbstractMultiValuedMapTest.this.makeObject().keySet();</span>
        }

        @Override
        public Set&lt;K&gt; makeFullCollection() {
<span class="fc" id="L880">            return AbstractMultiValuedMapTest.this.makeFullMap().keySet();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L885">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L890">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L895">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L900">            return false;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#values()}. This method runs through all
     * of the tests in {@link AbstractCollectionTest}. After modification
     * operations, {@link #verify()} is invoked to ensure that the map and the
     * other collection views are still valid.
     *
     * @return a {@link AbstractCollectionTest} instance for testing the map's
     *         values collection
     */
    public BulkTest bulkTestMultiValuedMapValues() {
<span class="fc" id="L915">        return new TestMultiValuedMapValues();</span>
    }

    public class TestMultiValuedMapValues extends AbstractCollectionTest&lt;V&gt; {
<span class="fc" id="L919">        public TestMultiValuedMapValues() {</span>
<span class="fc" id="L920">            super(&quot;&quot;);</span>
<span class="fc" id="L921">        }</span>

        @Override
        public V[] getFullElements() {
<span class="fc" id="L925">            return getSampleValues();</span>
        }

        @Override
        public Collection&lt;V&gt; makeObject() {
<span class="fc" id="L930">            return AbstractMultiValuedMapTest.this.makeObject().values();</span>
        }

        @Override
        public Collection&lt;V&gt; makeFullCollection() {
<span class="fc" id="L935">            return AbstractMultiValuedMapTest.this.makeFullMap().values();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L940">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L945">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L950">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L955">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L960">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L961">            setCollection(AbstractMultiValuedMapTest.this.getMap().values());</span>
<span class="fc" id="L962">            TestMultiValuedMapValues.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().values());</span>
<span class="fc" id="L963">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L967">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L968">            setCollection(AbstractMultiValuedMapTest.this.getMap().values());</span>
<span class="fc" id="L969">            TestMultiValuedMapValues.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().values());</span>
<span class="fc" id="L970">        }</span>

        @Override
        public Collection&lt;V&gt; makeConfirmedCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L975">            return null;</span>
        }

        @Override
        public Collection&lt;V&gt; makeConfirmedFullCollection() {
            // never gets called, reset methods are overridden
<span class="nc" id="L981">            return null;</span>
        }

    }

    /**
     * Bulk test {@link MultiValuedMap#keys()}. This method runs through all of
     * the tests in {@link AbstractBagTest}. After modification operations,
     * {@link #verify()} is invoked to ensure that the map and the other
     * collection views are still valid.
     *
     * @return a {@link AbstractBagTest} instance for testing the map's values
     *         collection
     */
    public BulkTest bulkTestMultiValuedMapKeys() {
<span class="fc" id="L996">        return new TestMultiValuedMapKeys();</span>
    }

    public class TestMultiValuedMapKeys extends AbstractMultiSetTest&lt;K&gt; {

<span class="fc" id="L1001">        public TestMultiValuedMapKeys() {</span>
<span class="fc" id="L1002">            super(&quot;&quot;);</span>
<span class="fc" id="L1003">        }</span>

        @Override
        public K[] getFullElements() {
<span class="fc" id="L1007">            return getSampleKeys();</span>
        }

        @Override
        public MultiSet&lt;K&gt; makeObject() {
<span class="fc" id="L1012">            return AbstractMultiValuedMapTest.this.makeObject().keys();</span>
        }

        @Override
        public MultiSet&lt;K&gt; makeFullCollection() {
<span class="fc" id="L1017">            return AbstractMultiValuedMapTest.this.makeFullMap().keys();</span>
        }

        @Override
        public boolean isNullSupported() {
<span class="nc" id="L1022">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isAddSupported() {
<span class="fc" id="L1027">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L1032">            return false;</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L1037">            return false;</span>
        }

        @Override
        public void resetFull() {
<span class="fc" id="L1042">            AbstractMultiValuedMapTest.this.resetFull();</span>
<span class="fc" id="L1043">            setCollection(AbstractMultiValuedMapTest.this.getMap().keys());</span>
<span class="fc" id="L1044">            TestMultiValuedMapKeys.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().keys());</span>
<span class="fc" id="L1045">        }</span>

        @Override
        public void resetEmpty() {
<span class="fc" id="L1049">            AbstractMultiValuedMapTest.this.resetEmpty();</span>
<span class="fc" id="L1050">            setCollection(AbstractMultiValuedMapTest.this.getMap().keys());</span>
<span class="fc" id="L1051">            TestMultiValuedMapKeys.this.setConfirmed(AbstractMultiValuedMapTest.this.getConfirmed().keys());</span>
<span class="fc" id="L1052">        }</span>

    }

    public BulkTest bulkTestAsMap() {
<span class="fc" id="L1057">        return new TestMultiValuedMapAsMap();</span>
    }

    public class TestMultiValuedMapAsMap extends AbstractMapTest&lt;K, Collection&lt;V&gt;&gt; {

<span class="fc" id="L1062">        public TestMultiValuedMapAsMap() {</span>
<span class="fc" id="L1063">            super(&quot;&quot;);</span>
<span class="fc" id="L1064">        }</span>

        @Override
        public Map&lt;K, Collection&lt;V&gt;&gt; makeObject() {
<span class="fc" id="L1068">            return AbstractMultiValuedMapTest.this.makeObject().asMap();</span>
        }

        @Override
        public Map&lt;K, Collection&lt;V&gt;&gt; makeFullMap() {
<span class="fc" id="L1073">            return AbstractMultiValuedMapTest.this.makeFullMap().asMap();</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public K[] getSampleKeys() {
<span class="fc" id="L1079">            K[] samplekeys = AbstractMultiValuedMapTest.this.getSampleKeys();</span>
<span class="fc" id="L1080">            Object[] finalKeys = new Object[3];</span>
<span class="fc bfc" id="L1081" title="All 2 branches covered.">            for (int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1082">                finalKeys[i] = samplekeys[i * 2];</span>
            }
<span class="fc" id="L1084">            return (K[]) finalKeys;</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Collection&lt;V&gt;[] getSampleValues() {
<span class="fc" id="L1090">            boolean isSetValuedMap = AbstractMultiValuedMapTest.this.getMap() instanceof SetValuedMap;</span>
<span class="fc" id="L1091">            V[] sampleValues = AbstractMultiValuedMapTest.this.getSampleValues();</span>
<span class="fc" id="L1092">            Collection&lt;V&gt;[] colArr = new Collection[3];</span>
<span class="fc bfc" id="L1093" title="All 2 branches covered.">            for(int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1094">                Collection&lt;V&gt; coll = Arrays.asList(sampleValues[i*2], sampleValues[i*2 + 1]);</span>
<span class="fc bfc" id="L1095" title="All 2 branches covered.">                colArr[i] = isSetValuedMap ? new HashSet&lt;V&gt;(coll) : coll;</span>
            }
<span class="fc" id="L1097">            return colArr;</span>
        }

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Collection&lt;V&gt;[] getNewSampleValues() {
<span class="fc" id="L1103">            boolean isSetValuedMap = AbstractMultiValuedMapTest.this.getMap() instanceof SetValuedMap;</span>
<span class="fc" id="L1104">            Object[] sampleValues = { &quot;ein&quot;, &quot;ek&quot;, &quot;zwei&quot;, &quot;duey&quot;, &quot;drei&quot;, &quot;teen&quot; };</span>
<span class="fc" id="L1105">            Collection&lt;V&gt;[] colArr = new Collection[3];</span>
<span class="fc bfc" id="L1106" title="All 2 branches covered.">            for (int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L1107">                Collection&lt;V&gt; coll = Arrays.asList((V) sampleValues[i * 2], (V) sampleValues[i * 2 + 1]);</span>
<span class="fc bfc" id="L1108" title="All 2 branches covered.">                colArr[i] = isSetValuedMap ? new HashSet&lt;V&gt;(coll) : coll;</span>
            }
<span class="fc" id="L1110">            return colArr;</span>
        }

        @Override
        public boolean isAllowNullKey() {
<span class="nc" id="L1115">            return AbstractMultiValuedMapTest.this.isAllowNullKey();</span>
        }

        @Override
        public boolean isPutAddSupported() {
<span class="fc" id="L1120">            return false;</span>
        }

        @Override
        public boolean isPutChangeSupported() {
<span class="fc" id="L1125">            return false;</span>
        }

        @Override
        public boolean isRemoveSupported() {
<span class="fc" id="L1130">            return AbstractMultiValuedMapTest.this.isRemoveSupported();</span>
        }
        
        @Override
        public boolean areEqualElementsDistinguishable() {
            // work-around for a problem with the EntrySet: the entries contain
            // the wrapped collection, which will be automatically cleared
            // when the associated key is removed from the map as the collection
            // is not cached atm.
<span class="fc" id="L1139">            return true;</span>
        }

        @Override
        public boolean isTestSerialization() {
<span class="fc" id="L1144">            return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span>commons-collections-collections-4.1 (25-Jun-2019 5:26:10 PM)</div></body></html>